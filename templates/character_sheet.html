<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<script>
    function showTab(tabName) {
        document.querySelectorAll(".content").forEach(c => c.style.display = "none");
        document.getElementById(tabName).style.display = "flex";

        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelector(`[data-tab='${tabName}']`).classList.add("active");
        updateFloatingButton(tabName);
    }

    function toggleCollapsible(event) {
        let content = event.currentTarget.nextElementSibling;
        let currentDisplay = window.getComputedStyle(content).display;
        content.style.display = content.style.display === "block" ? "none" : "block";
    }

    function togglePanel(event) {
        // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å—ã
        if (event.target.type === "checkbox") return;
        
        let content = event.currentTarget.nextElementSibling;
        content.style.display = content.style.display === "block" ? "none" : "block";
    }

    let timeoutId;

    function editText(event, field) {
        console.log(event)
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        clearTimeout(timeoutId);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä
        timeoutId = setTimeout(() => {
            const inputValue = event.target.value;
            console.log(event.target.value)
            if (inputValue.trim() !== "") {  // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª–µ –Ω–µ –ø—É—Å—Ç–æ–µ
                sendDataToServer(inputValue, field);
            }
        }, 300);  // –ó–∞–¥–µ—Ä–∂–∫–∞ 300 –º—Å
    }



    function updateCheckboxes(event, level) {
        event.stopPropagation(); 
        
        let checkboxes = Array.from(event.currentTarget.parentElement.querySelectorAll("input"));

        if (event.target.checked) {
            event.target.checked = false;


            for (let i = 0; i < checkboxes.length; i++) {
                if (!checkboxes[i].checked) {
                    checkboxes[i].checked = true;
                    break;
                }
            }

        } else { 
            event.target.checked = true;


            for (let i = checkboxes.length - 1; i >= 0; i--) {
                if (checkboxes[i].checked) {
                    checkboxes[i].checked = false;
                    break;
                }
            }

        }

        let checkedCount = 0;

        checkboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                checkedCount++;
            }
        });

        fetch('/update_checkbox', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                level: level,
                used: checkedCount,
            }),
        }).then(response => response.json()).then(data => {
            if (data.status !== 'success') {
                console.error('Failed to update checkbox state');
            } else {console.log(data.used + " " + data.level)}
        });
    }


    

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function sendDataToServer(value, field) {
        // URL —Å–µ—Ä–≤–µ—Ä–∞

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const data = {
            value: value,
            field: field
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/update_field', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", result);
        })
        .catch(error => {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            console.error("–û—à–∏–±–∫–∞:", error);
        });
    }

    // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥
    const buttonActions = {
            stats: () => alert("–î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ Home!"),
            items: () => alert("–î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ Settings!"),
            feats: null // null –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∞ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ –∫–Ω–æ–ø–∫–∏ –Ω–µ –±—É–¥–µ—Ç
        };

    function updateFloatingButton(tab) {
        if (buttonActions[tab]) {
            floatingButton.style.display = "block";
            floatingButton.onclick = buttonActions[tab];
        } else {
            floatingButton.style.display = "none";
        }
    }   

    document.addEventListener("DOMContentLoaded", function() {


        showTab("spells");

        document.querySelectorAll(".collapsible").forEach(item => {
            item.addEventListener("click", toggleCollapsible);
        });

        document.querySelectorAll(".panel").forEach(item => {
            item.addEventListener("click", togglePanel);
        });

        // document.querySelectorAll(".checkbox-group input").forEach(checkbox => {
        //     checkbox.addEventListener("click", updateCheckboxes);
        // });

        // document.querySelectorAll(".input-field").forEach(item => {
        //     item.addEventListener("input", editText);
        // });
        
        const floatingButton = document.getElementById("floatingButton");




    });
</script>

<body>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
    <button onclick="downloadFile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑ –±–∞–∑—ã</button>
    <div id="common" class="content" style="display: none;">
        <span><strong>–¢–µ–∫—É—â–∏–µ –ü–ó: </strong><input oninput="((event) => editText(event, ['Hit Points', 'Current']))(event)" class= "input-field" type="text" value={{data["Hit Points"]["Current"]}}></span>
        <span><strong>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ü–ó: </strong><input oninput="((event) => editText(event, ['Hit Points', 'Maximum']))(event)" class= "input-field" type="text" value={{data["Hit Points"]["Maximum"]}}></span>
        <span><strong>–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ü–ó: </strong><input oninput="((event) => editText(event, ['Hit Points', 'Temporal']))(event)" class= "input-field" type="text" value={{data["Hit Points"]["Temporal"]}}></span>
        <span><strong>–ö–ª–∞—Å—Å –±—Ä–æ–Ω–∏: </strong>{{data["Armor Class"]}}</span>
        <span><strong>–°–∫–æ—Ä–æ—Å—Ç—å: </strong>{{data["Speed"]}}</span>
        <span><strong>–ë–æ–Ω—É—Å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞: </strong>{{data["Bonus"]}}</span>
        <span><strong>–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞: </strong>{{data["Initiative"]}}</span>
    </div>
    <div id="stats" class="content" style="display: none;">
        <h2>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
        {% for key, value in data["Attributes"].items() %}
        <span><strong>{{ key }}:</strong> {{ value }}</span>
        {% endfor %}
        <h2>–ò—Å–ø—ã—Ç–∞–Ω–∏—è</h2>
        {% for key, value in data["Saves"].items() %}
        <span><strong>{{ key }}:</strong> {{ value }}</span>
        {% endfor %}
        <h2>–ù–∞–≤—ã–∫–∏</h2>
        {% for key, value in data["Skills"].items() %}
        <span><strong>{{ key }}:</strong> {{ value }}</span>
        {% endfor %}
    </div>
    <div id="feats" class="content" style="display: none;">
        {% for key, value in data["Feats"].items() %}
            <div class="panel">{{ key }}</div>
            <div class="panel-content">
                {% for item in value %}
                    <div class="collapsible">{{ item["name"] }}</div>
                    <div class="collapsible-content">
                        {{ item["description"] | safe }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}       
    </div>
    <div id="items" class="content" style="display: none;">
        {% for item in data.Equipment %}
            <div class="collapsible">
                <img src="/static/img/token-runed-circle-green.webp" class="collapsible-icon" alt="icon">
                <span class="collapsible-label">{{ item["item"] }}</span>
            </div>
            <div class="collapsible-content">
                <p> {{ item["description"] }}</p>
            </div>
        {% endfor %}
    </div>
    <div id="spells" class="content">
        <span><strong>–ó–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—å–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞: </strong>{{data["Spells"]["Ability"]}}</span>
        <span><strong>–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—ã—Ç–∞–Ω–∏–π: </strong>{{data["Spells"]["Save"]}}</span>
        <span><strong>–ë–æ–Ω—É—Å –∞—Ç–∞–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è–º–∏: </strong>{{data["Spells"]["Attack"]}}</span>
        {% for i in range(data.Spells.slots|length) %}
            <div class="panel">
                {{ i }}-–π –∫—Ä—É–≥    
                <div class="checkbox-group" onclick="((event) => updateCheckboxes(event, '{{ i }}'))(event)">
                    {% for j in range(data.Spells.slots[i]["available"]) %}
                    <input type="checkbox" {% if j < data.Spells.slots[i]["used"] %}checked{% endif %}>
                    {% endfor %}     
                </div>
            </div>
            <div class="panel-content">
                {% for spell in data.Spells.list %}
                    {% if "level" in spell and spell["level"] == i %}
                        <div class="collapsible">{{ spell["name"]["russian"] }}</div>
                        <div class="collapsible-content">
                            <p><i>{{ spell["school"] }}</i></p>
                            <p><strong>–í—Ä–µ–º—è –Ω–∞–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è:</strong> {{ spell["cast_time"] }}</p>
                            <p><strong>–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</strong> {{ spell["distance"] }}</p>
                            <p><strong>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:</strong> {{ spell["components"] }}</p>
                            <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ spell["duration"] }}</p>
                            <p>{{ spell["description"] }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endfor %}    
    </div>
    <div id="bio" class="content" style="display: none;">üë§ –ë–∏–æ</div>
    <button id="floatingButton" class="floating-button">+</button>
    <div class="tab-bar">
        <div class="tab active" data-tab="common" onclick="showTab('common')">
            üè†
        </div>
        <div class="tab" data-tab="stats" onclick="showTab('stats')">
            üîç
        </div>
        <div class="tab" data-tab="feats" onclick="showTab('feats')">
            ü¶∂
        </div>
        <div class="tab" data-tab="items" onclick="showTab('items')">
            üëú
        </div>
        <div class="tab" data-tab="spells" onclick="showTab('spells')">
            üìï
        </div>
        <div class="tab" data-tab="bio" onclick="showTab('bio')">
            üë§
        </div>
    </div>

    <script>
        function downloadFile() {
            fetch('/download_json')
                .then(response => response.json())
                .then(data => {
                    let jsonString = JSON.stringify(data, null, 4); // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º JSON –∫—Ä–∞—Å–∏–≤–æ
                    let blob = new Blob([jsonString], { type: 'application/json' });
                    let a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'character_data.json';
                    a.click();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.');
                });
        }

        function uploadFile() {
            let fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!');
                return;
            }

            let file = fileInput.files[0];
            let reader = new FileReader();

            reader.onload = function(event) {
                try {
                    let jsonData = JSON.parse(event.target.result);

                    fetch('/upload_json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(jsonData),
                    }).then(response => response.json()).then(data => {
                        if (data.status === 'success') {
                            alert('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –±–∞–∑—É!');
                        } else {
                            alert('–û—à–∏–±–∫–∞: ' + data.error);
                        }
                    }).catch(error => {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.');
                    });

                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON.');
                }
            };

            reader.readAsText(file);
        }

    </script>

</body>
</html>
